# Автоматическое обновление данных после создания проекта

## Проблема
После успешного создания проекта через форму на странице Dashboard, новый проект не отображался на странице Projects до ручного нажатия кнопки "Обновить данные".

## Решение
Реализован механизм автоматического обновления данных с использованием глобального состояния и подписок.

## Архитектура решения

### 1. Глобальное состояние (Store)
**Файл:** `b5-agent/src/lib/state/projectsRefresh.svelte.js`

Создан простой store для управления обновлением данных проектов:
- `trigger` - счетчик обновлений (реактивное состояние)
- `refresh()` - метод для запуска обновления
- `subscribe(callback)` - метод для подписки на обновления

### 2. Модальное окно создания проекта
**Файл:** `b5-agent/src/lib/components/ProjectSubmitModal.svelte`

После успешного создания проекта:
1. Вызывается `projectsRefresh.refresh()` - глобальное уведомление
2. Вызывается `onSuccess()` callback - локальное уведомление (опционально)

### 3. Страница Projects
**Файл:** `b5-agent/src/routes/(protected)/projects/+page.svelte`

При монтировании компонента:
- Подписывается на события `projectsRefresh`
- При получении события вызывает `refreshData()` для перезагрузки данных
- При размонтировании отписывается от событий

### 4. Страница Dashboard
**Файл:** `b5-agent/src/routes/(protected)/dashboard/+page.svelte`

При монтировании компонента:
- Подписывается на события `projectsRefresh`
- При получении события вызывает `invalidate('/dashboard')` для обновления статистики
- Передает callback `handleProjectCreated` в модальное окно

## Поток данных

```
1. Пользователь создает проект через форму
   ↓
2. ProjectSubmitModal.svelte
   - Отправляет данные на сервер
   - При успехе вызывает projectsRefresh.refresh()
   ↓
3. projectsRefresh.svelte.js
   - Увеличивает счетчик trigger
   - Вызывает все зарегистрированные callbacks
   ↓
4. Projects page
   - Получает уведомление через подписку
   - Вызывает refreshData() → invalidate(() => true)
   - Перезагружает данные с сервера
   ↓
5. Dashboard page
   - Получает уведомление через подписку
   - Вызывает invalidate('/dashboard')
   - Обновляет статистику
```

## Преимущества решения

1. **Автоматическое обновление** - данные обновляются сразу после создания проекта
2. **Глобальная синхронизация** - все страницы получают уведомление одновременно
3. **Расширяемость** - легко добавить новые подписчики
4. **Чистота кода** - компоненты слабо связаны между собой
5. **Производительность** - обновляются только необходимые данные

## Использование

### Подписка на обновления
```javascript
import { onMount } from 'svelte';
import { projectsRefresh } from '$lib/state/projectsRefresh.svelte.js';

onMount(() => {
  const unsubscribe = projectsRefresh.subscribe(() => {
    console.log('Projects updated, refreshing...');
    // Ваш код обновления данных
  });

  // Cleanup
  return unsubscribe;
});
```

### Запуск обновления
```javascript
import { projectsRefresh } from '$lib/state/projectsRefresh.svelte.js';

// После создания/изменения/удаления проекта
projectsRefresh.refresh();
```

## Тестирование

1. Откройте страницу Dashboard
2. Нажмите "Создать проект"
3. Заполните и отправьте форму
4. Проверьте:
   - Статистика на Dashboard обновилась автоматически
   - Перейдите на страницу Projects
   - Новый проект отображается в списке без ручного обновления

## Отладка

В консоли браузера будут видны логи:
- `Projects refresh triggered, reloading data...` - на странице Projects
- `Projects refresh triggered on dashboard, reloading stats...` - на странице Dashboard
- `Project created, refreshing dashboard stats...` - при создании проекта

## Будущие улучшения

1. Добавить debounce для множественных обновлений
2. Добавить оптимистичные обновления (показывать проект до ответа сервера)
3. Добавить WebSocket для real-time обновлений
4. Кэшировать данные для быстрого отображения
