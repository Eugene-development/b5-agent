# SSR Authentication Debugging Guide

## –ü—Ä–æ–±–ª–µ–º–∞
–ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ (bonus5.ru) —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, —Ö–æ—Ç—è –ª–æ–∫–∞–ª—å–Ω–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. b5-agent/src/lib/api/server.js
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ GraphQL –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–±—Ä–∞–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ Cookie –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è SSR)
- –ü–æ–ª–∞–≥–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ `Authorization: Bearer` —Ç–æ–∫–µ–Ω

### 2. b5-agent/src/hooks.server.js
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–∫–µ–Ω–∞
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è userId, email, tokenLength

### 3. b5-api-2/app/Http/Middleware/AuthenticateFromCookie.php
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ Authorization header –∏ cookie

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### 1. –î–µ–ø–ª–æ–π b5-agent
```bash
cd b5-agent
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose up -d --build
```

### 2. –î–µ–ø–ª–æ–π b5-api-2
```bash
cd b5-api-2
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose up -d --build
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ b5-agent
```bash
# –ù–∞–π—Ç–∏ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker ps | grep agent

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker logs <container-name> --tail 100 -f
```

–ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:
- `üîê Auth middleware: Processing token` - —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –∏–∑ cookie
- `üì° GraphQL SSR [GetAgentBonuses]: Making request` - –∑–∞–ø—Ä–æ—Å –∫ API

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ b5-api-2
```bash
# –ù–∞–π—Ç–∏ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker ps | grep api2

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Laravel
docker exec <container-name> tail -f storage/logs/laravel.log
```

–ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:
- `AuthenticateFromCookie middleware` - –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å
- `AgentBonusesQuery: Auth check` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Ä–µ–∑–æ–ª–≤–µ—Ä–µ

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. b5-agent: `üîê Auth middleware: User authenticated` —Å userId –∏ email
2. b5-agent: `üì° GraphQL SSR: Making request` —Å hasToken=true
3. b5-api-2: `AuthenticateFromCookie middleware` —Å has_auth_header=true
4. b5-api-2: `AgentBonusesQuery: Auth check` —Å has_user=true

### –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ JWT_SECRET –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤ b5-auth-2 –∏ b5-api-2
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ cookie `b5_auth_token` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å –¥–æ–º–µ–Ω–æ–º `.bonus5.ru`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –∏—Å—Ç—ë–∫ (TTL = 60 –º–∏–Ω—É—Ç)

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –¢–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
**–°–∏–º–ø—Ç–æ–º:** `hasToken=false` –≤ –ª–æ–≥–∞—Ö b5-agent
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É cookie –≤ login endpoint

### 2. –¢–æ–∫–µ–Ω –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è
**–°–∏–º–ø—Ç–æ–º:** `has_user=false` –≤ –ª–æ–≥–∞—Ö b5-api-2
**–†–µ—à–µ–Ω–∏–µ:** 
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å JWT_SECRET
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞

### 3. –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API
**–°–∏–º–ø—Ç–æ–º:** `has_user=true`, –Ω–æ `bonuses: 0`
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
1. –û—Ç–∫—Ä—ã—Ç—å https://bonus5.ru/finances
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Debug Info –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
4. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º
