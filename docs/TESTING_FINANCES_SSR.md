# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SSR –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤

## –¶–µ–ª—å

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/finances` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —á–µ—Ä–µ–∑ Server-Side Rendering —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º httpOnly cookies.

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
2. –í –±—Ä–∞—É–∑–µ—Ä–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ httpOnly cookie `b5_auth_token`
3. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã –≤ —Å–∏—Å—Ç–µ–º–µ

## –®–∞–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É Network
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/finances` (–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ - Ctrl+Shift+R)
4. –ù–∞–π–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–π HTML –∑–∞–ø—Ä–æ—Å –∫ `/finances`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í HTML –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –±–æ–Ω—É—Å–∞—Ö (–Ω–µ –ø—É—Å—Ç—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã
- –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ `/login`

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

–û—Ç–∫—Ä–æ–π—Ç–µ Console –≤ DevTools.

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
‚úÖ Finances SSR: Loaded data in XXXms
```

**–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
üîÑ Finances: Loading data on client (no httpOnly cookie)
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (Docker logs –∏–ª–∏ PM2 logs).

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
üöÄ Finances SSR: Starting server-side load
üë§ Finances SSR: Loading data for user: user@example.com
üí∞ Finances SSR: Starting data load
‚úÖ Finances SSR: Loaded data in XXXms { bonuses: X, payments: Y, stats: {...} }
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ httpOnly cookie

–í DevTools ‚Üí Application ‚Üí Cookies ‚Üí `https://agent.bonus5.ru`

**–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å cookie:**
- Name: `b5_auth_token`
- Value: JWT —Ç–æ–∫–µ–Ω
- HttpOnly: ‚úì
- Secure: ‚úì
- SameSite: Lax –∏–ª–∏ Strict

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ GraphQL –∑–∞–ø—Ä–æ—Å–æ–≤

–í Network tab –Ω–∞–π–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `/graphql`.

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
- –ó–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <token>`
- –û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–Ω–µ –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã)
- Status: 200 OK

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ü—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

**–°–∏–º–ø—Ç–æ–º—ã:**
- –õ–æ–∫–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
- –í –ª–æ–≥–∞—Ö: `‚ö†Ô∏è Finances SSR: No authentication token found in httpOnly cookie`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ httpOnly cookie –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–º–µ–Ω—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç (auth –∏ agent –Ω–∞ –æ–¥–Ω–æ–º –¥–æ–º–µ–Ω–µ)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS –∏ SameSite

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∞ 401 Unauthorized

**–°–∏–º–ø—Ç–æ–º—ã:**
- GraphQL –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 401
- –í –ª–æ–≥–∞—Ö: `‚ùå Finances SSR: Failed to load data: ... 401`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –∏—Å—Ç–µ–∫
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ JWT –Ω–∞ backend

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–º–µ—Å—Ç–æ SSR

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –∫–æ–Ω—Å–æ–ª–∏: `üîÑ Finances: Loading data on client (no httpOnly cookie)`
- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `+page.server.js`, –∞ –Ω–µ `+page.js`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ httpOnly cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `hooks.server.js` - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏

–°—Ç—Ä–∞–Ω–∏—Ü–∞ `/finances` –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `/projects`:

| –ê—Å–ø–µ–∫—Ç | /projects | /finances |
|--------|-----------|-----------|
| Load function | `+page.server.js` | `+page.server.js` |
| –¢–æ–∫–µ–Ω | `locals.token` | `locals.token` |
| SSR | ‚úì | ‚úì |
| Fallback | ‚úì | ‚úì |

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: < 500ms
- Time to First Byte (TTFB): < 1s
- First Contentful Paint (FCP): < 2s

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞
‚úÖ Finances SSR: Loaded data in 234ms
```

## Rollback –ø–ª–∞–Ω

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `+page.js`:
```bash
git checkout HEAD~1 -- src/routes/(protected)/finances/+page.js
```

2. –£–¥–∞–ª–∏—Ç–µ `+page.server.js`:
```bash
rm src/routes/(protected)/finances/+page.server.js
```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `FINANCES_SSR_FIX.md`
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: `src/routes/(protected)/projects/+page.server.js`
- API —É—Ç–∏–ª–∏—Ç—ã: `src/lib/api/server.js`
