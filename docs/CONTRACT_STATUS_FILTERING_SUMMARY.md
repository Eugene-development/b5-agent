# Фильтрация договоров и заказов по статусу - Итоговая документация

## Обзор проблемы

В сервисе b5-agent были обнаружены две проблемы с отображением неактивных договоров и заказов:

1. **Модальное окно проекта**: Неактивные заказы отображались в списке, хотя бонусы по ним не начислялись
2. **Страница финансов**: Договоры в статусе "Обработка" отображались и показывали начисленные бонусы, хотя не должны были

## Решения

### 1. Фильтрация неактивных заказов в модальном окне

**Файл**: `b5-agent/src/lib/components/BonusDetailsSection.svelte`

**Изменение**: Добавлена фильтрация заказов по полю `is_active`

```svelte
{#if bonusDetails.orders && bonusDetails.orders.filter(order => order.is_active).length > 0}
    <div>
        <h4 class="mb-2 text-sm font-semibold text-amber-500">
            Бонусы по заказам ({bonusDetails.orders.filter(order => order.is_active).length})
        </h4>
        <div class="space-y-2">
            {#each bonusDetails.orders.filter(order => order.is_active) as order}
```

**Результат**: Неактивные заказы больше не отображаются в модальном окне просмотра проекта.

### 2. Фильтрация договоров по статусу на странице финансов

**Файлы**: 
- `b5-api-2/app/GraphQL/Queries/AgentBonusesQuery.php`
- `b5-api-2/app/Services/BonusService.php`

**Изменение**: Добавлена фильтрация бонусов по статусу договора

Бонусы отображаются только если:
- Договор в статусе "Заключён" (signed) или далее (НЕ в статусе "Обработка" / preparing)
- ИЛИ это бонус от заказа (не от договора)

**Результат**: 
- Договоры в статусе "Обработка" не отображаются на странице финансов
- Бонусы по таким договорам не учитываются в статистике
- Бонусы начисляются и отображаются только когда договор переходит в статус "Заключён"

## Статусы договоров

1. **Обработка** (preparing) - статус по умолчанию, бонусы НЕ отображаются
2. **Заключён** (signed) - бонусы начинают отображаться
3. **Выполнен** (completed) - бонусы отображаются
4. **Рекламация** (claim) - бонусы отображаются
5. **Отказ** (rejected) - бонусы отображаются
6. **Расторгнут** (terminated) - бонусы отображаются

## Логика начисления бонусов

### Для договоров:
Бонус переходит в статус "Доступно к выплате" только если:
- Статус договора = "Заключён" (signed)
- Статус оплаты партнёром = "Оплачено" (paid)
- Договор активен (is_active = true)

### Для заказов:
Бонус переходит в статус "Доступно к выплате" только если:
- Статус заказа = "Доставлен" (delivered)
- Заказ активен (is_active = true)

## Тестирование

### Сценарий 1: Создание договора в статусе "Обработка"
1. Создать договор в b5-admin со статусом "Обработка"
2. Проверить страницу финансов в b5-agent
3. **Ожидаемый результат**: Договор НЕ отображается, бонусы НЕ показываются

### Сценарий 2: Перевод договора в статус "Заключён"
1. Изменить статус договора на "Заключён" в b5-admin
2. Проверить страницу финансов в b5-agent
3. **Ожидаемый результат**: Договор отображается, бонусы показываются

### Сценарий 3: Неактивный заказ в проекте
1. Создать заказ и установить is_active = false
2. Открыть модальное окно проекта в b5-agent
3. **Ожидаемый результат**: Заказ НЕ отображается в списке

## Связанные файлы

### Frontend (b5-agent):
- `src/lib/components/BonusDetailsSection.svelte`
- `src/lib/components/ProjectDetailsModal.svelte`
- `src/routes/(protected)/finances/+page.svelte`
- `src/lib/components/finances/BonusesTable.svelte`

### Backend (b5-api-2):
- `app/GraphQL/Queries/AgentBonusesQuery.php`
- `app/GraphQL/Queries/AgentBonusStatsQuery.php`
- `app/Services/BonusService.php`
- `app/Models/AgentBonus.php`
- `app/Models/Contract.php`

### Database (b5-db-2):
- `database/migrations/2025_12_13_120001_create_contract_statuses_table.php`
- `database/migrations/2025_12_14_120000_update_contract_status_preparing_to_processing.php`

## Диагностика проблем

### Договор не отображается на странице финансов

**Причина**: Договор в статусе "Обработка" (preparing)

**Решение**: Изменить статус договора на "Заключён" (signed) в b5-admin

### Заказ не отображается на странице финансов

**Возможные причины**:
1. `order_amount` не указан или равен 0
2. `is_active = false`
3. Бонус не был создан при создании заказа

**Решение**: См. документацию `b5-api-2/docs/ORDER_BONUS_NOT_DISPLAYING.md`

**Быстрая диагностика**:
```bash
cd b5-api-2
php test-order-bonus.php <order_id>
```

### Заказ отображается дважды на странице финансов

**Причина**: Бонус создавался дважды - в событии `Order::created` и в мутации `CreateOrder`

**Решение**: Удалён дублирующий вызов из мутации. См. `b5-api-2/docs/DUPLICATE_BONUSES_FIX.md`

**Удаление существующих дубликатов**:
```bash
cd b5-api-2
php remove-duplicate-bonuses.php --dry-run  # проверка
php remove-duplicate-bonuses.php            # удаление
```

### Статус заказа "Не указано" при создании

**Причина**: Дефолтный статус не устанавливался, если метод `getDefault()` возвращал `null`

**Решение**: Добавлена проверка и fallback на первый активный статус. См. `b5-api-2/docs/ORDER_DEFAULT_STATUS_FIX.md`

## Дата изменения
22 декабря 2024
