# Обновление формы создания проекта на Dashboard

## Изменения

### 1. Удалены внешние ссылки
- Убрана ссылка на форму на сайте mebelmobile.ru
- Убрана ссылка на Telegram бот

### 2. Добавлена форма в модальном окне
- Создан новый компонент `ProjectSubmitModal.svelte`
- Форма открывается по клику на кнопку "Создать проект"
- Форма использует тот же API endpoint, что и форма в проекте b5-mm

### 3. Новые файлы
- `b5-agent/src/lib/components/ProjectSubmitModal.svelte` - компонент модального окна с формой

### 4. Измененные файлы
- `b5-agent/src/routes/(protected)/dashboard/+page.svelte` - обновлена страница dashboard
- `b5-agent/package.json` - добавлена зависимость `ulid`

## Функциональность

### Модальное окно
- Открывается по клику на кнопку "Создать проект"
- Закрывается по клику вне окна, на кнопку закрытия или клавишу Escape
- Автоматически закрывается через 2 секунды после успешной отправки

### Форма
- **Автоматическая подстановка секретного ключа агента:**
  - Ключ автоматически заполняется из профиля пользователя при открытии модального окна
  - Поле секретного ключа доступно только для чтения (readonly)
  - Ключ восстанавливается после успешной отправки формы
  - Подсказка под полем информирует пользователя об автоматической подстановке
- Валидация всех полей
- Нормализация номера телефона (поддержка форматов 8XXXXXXXXXX и 7XXXXXXXXXX)
- Отображение сообщений об успехе и ошибках
- Индикатор загрузки при отправке

### API
- Использует публичный endpoint `/api/projects/public-submit`
- Отправляет данные в том же формате, что и форма в b5-mm
- Обрабатывает ошибки валидации и другие ошибки API

## Исправления

### 1. Проблема с секретным ключом
**Проблема:** При отправке формы возникала ошибка "Введите корректный секретный ключ"

**Причина:** Использовалось неправильное поле для получения секретного ключа из профиля пользователя

**Решение:** 
- Было: `authState.user?.secret_key`
- Стало: `authState.user?.key`

### 2. Мерцание уведомления о секретном ключе
**Проблема:** При отправке формы на короткое время уведомление "Ваш секретный ключ подставлен автоматически" менялось на "Секретный ключ не найден"

**Причина:** `form.reset()` очищал все поля, включая секретный ключ, что вызывало временное пустое состояние

**Решение:** 
- Вместо `form.reset()` используется выборочная очистка полей
- Секретный ключ остается неизменным после отправки формы
- Очищаются только поля с данными клиента (имя, телефон, адрес, комментарий)

## Автоматическое обновление данных

### Проблема
После создания проекта он не отображался на странице Projects до ручного обновления.

### Решение
Реализован механизм автоматического обновления данных:
- Создан глобальный store `projectsRefresh` для управления обновлениями
- После успешного создания проекта автоматически обновляются:
  - Список проектов на странице Projects
  - Статистика на странице Dashboard
- Используется паттерн pub/sub для слабой связанности компонентов

Подробности: см. `AUTO_REFRESH_IMPLEMENTATION.md`

## Тестирование

Для тестирования:
1. Войдите в личный кабинет агента
2. На странице Dashboard нажмите кнопку "Создать проект"
3. Проверьте, что секретный ключ загружен автоматически (зеленая галочка под полем)
4. Заполните форму и отправьте
5. Проверьте автоматическое обновление:
   - Статистика на Dashboard обновилась (счетчик активных проектов увеличился)
   - Перейдите на страницу Projects
   - Новый проект отображается в списке без ручного обновления

Подробная инструкция по тестированию: см. `TESTING_PROJECT_FORM.md`
